# CLAUDE.md - AI-EA プロジェクトガイド

## プロジェクト概要

AI搭載FX/暗号資産自動売買システム（AI-EA-Advanced）の開発プロジェクト。
MetaTrader 5と連携し、テクニカル分析とAIを組み合わせた自動売買を行う。

## 重要: トレーディングボット開発の落とし穴

### ⚠️ 絶対に避けるべき失敗パターン

```
1. オーバーフィッティング
   - バックテスト結果が良すぎる（勝率90%以上）は危険信号
   - パラメータを少し変えて結果が激変するなら過学習
   - 必ずウォークフォワードテストで検証すること

2. 不十分なテスト
   - バックテストだけでは不十分
   - 必須: バックテスト → ウォークフォワード → ペーパートレード（3ヶ月以上）
   - 少なくとも100トレード以上のサンプルが必要

3. 取引コストの無視
   - スプレッド、スリッページ、手数料を必ずバックテストに含める
   - 実際の利益はバックテスト結果の50-75%になることが多い

4. リスク管理の欠如
   - ストップロス/テイクプロフィットは必須
   - 連続損失時の自動停止機能を実装すること
   - 最大ドローダウン制限を設けること
```

### 開発時のチェックリスト

コードを書く/修正する前に確認:

```
□ エラーハンドリング
  - API障害時の動作は？
  - データ欠損時の動作は？
  - ネットワーク切断時の動作は？

□ リスク制御
  - 最大損失額の上限は設定されているか？
  - 連続損失時の停止機能はあるか？
  - ポジションサイズの上限はあるか？

□ ログ記録
  - 全ての取引判断がログに記録されるか？
  - エラーは適切にログされるか？
  - デバッグに十分な情報があるか？

□ テスト
  - 変更後にバックテストを実行したか？
  - 複数の相場環境でテストしたか？
  - エッジケースは考慮したか？
```

## アーキテクチャ

```
src/
├── backtest/          # バックテストエンジン
│   ├── engine.py      # バックテスト実行
│   ├── data_loader.py # 価格データ読み込み
│   └── indicators.py  # テクニカル指標計算
├── optimizer/         # パラメータ最適化
│   ├── optuna_optimizer.py  # Optuna最適化
│   ├── ai_analyzer.py       # AI分析
│   └── optimization_loop.py # 最適化ループ
├── config/            # 設定管理
│   └── param_manager.py     # パラメータ制限
└── scheduler/         # スケジューラー
    └── optimizer_scheduler.py

main_genai_custom.py   # メインFastAPIサーバー（v10.7）
```

## 重要なパラメータ制限

パラメータを変更する際は必ず `src/config/param_manager.py` の `PARAM_LIMITS` を参照。
範囲外の値を設定すると予期しない動作を引き起こす可能性がある。

## コマンド

```bash
# サーバー起動
python main_genai_custom.py

# バックテスト実行
python test_backtest.py

# 最適化実行
python -m src.optimizer.optimization_loop

# テスト実行
pytest tests/
```

## 開発ルール

### 1. 変更は小さく、段階的に

大きな変更は避け、一度に1つのパラメータや機能のみ変更する。
変更後は必ずバックテストで検証。

### 2. 全てを記録する

- 取引判断の理由をログに残す
- パラメータ変更の経緯をコメントに残す（例: `# v10.7: 1.2→1.5（勝率48→53%）`）
- 実験結果は `docs/` に記録

### 3. 安全第一

利益より先にリスク管理を考える:
- ストップロスは必須
- 最大ポジション数制限
- 連続損失時のクールダウン

### 4. 現実的な期待値を持つ

- 勝率55-70%が現実的
- 月利3-10%が現実的
- バックテスト結果の50-75%が実際の成績

## 注意事項

### 販売に関する法的要件（日本）

売り切り型（買い切り）で販売する場合は投資助言業登録不要。
ただし以下は禁止:
- 月額課金（サブスク）
- 成功報酬型
- 「必ず儲かる」等の断定的表現
- 会員限定販売

詳細は `docs/business/legal-research-japan.md` を参照。

## 参考ドキュメント

- `docs/business/business-plan-jp.md` - ビジネスプラン
- `docs/business/development-guide-jp.md` - 開発ガイド
- `docs/business/legal-research-japan.md` - 法的調査
