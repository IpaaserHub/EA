AI EAロジック仕様書（アドバンス版 Ver 2.1）

本ドキュメントは、Pythonサーバー（main_advanced.py）に実装された自動売買ロジックの解説書です。
単なるインジケーターのシグナルではなく、**「環境認識（相場の状況把握）」**を行った上で、優位性の高いポイントでのみエントリーする設計となっています。

1. 戦略の概要 (Concept)

「トレンドフォロー × 押し目買い・戻り売り」
相場の大きな流れ（トレンド）には逆らわず、その流れの中で一時的に価格が有利な位置（押し目・戻り目）に来た瞬間を狙い撃ちします。

トレンド判断: 線形回帰（Linear Regression）を使用

エントリー位置: 直近レンジ内の相対位置（フィボナッチ的な考え方）

資金管理: ATR（ボラティリティ）に基づく動的な損切り・利確設定

2. 環境認識ロジック (AIの「目」)

AIは、過去の確定足データ（デフォルト100本）を分析し、以下の3つの数値を常に計算しています。

A. トレンドの傾き (Slope)

手法: 統計学の「線形回帰分析」を使用。

判定:

Slope > 0.0001: 上昇トレンド（買い目線）

Slope < -0.0001: 下降トレンド（売り目線）

それ以外: レンジ相場（様子見）

B. 現在価格の相対位置 (Position in Range)

手法: 過去100本分の「最高値」と「最安値」を特定し、現在価格がその中のどの位置にいるか（0%〜100%）を計算します。

0.0 (0%): 最安値と同じ

1.0 (100%): 最高値と同じ

0.5 (50%): ちょうど真ん中

目的: 「高値掴み」や「安値売り」を防ぐため。

C. 相場の変動幅 (ATR)

手法: 過去14期間の価格変動幅の平均（ATR）を計算。

目的: 「今の相場はどれくらい荒れているか」を把握し、損切り幅を自動調整するために使用。

3. エントリー・ルール (AIの「決断」)

上記の環境認識に基づき、以下の条件がすべて揃った瞬間にシグナルを出します。

【買いエントリー (BUY)】

トレンド: 上昇中であること（Slope > 正の閾値）

位置: 価格が一時的に下がってきていること（Position < 0.4）

※「上昇トレンド中なのに、価格は安値圏（40%以下）にある」＝絶好の押し目買いチャンスと判断。

【売りエントリー (SELL)】

トレンド: 下降中であること（Slope < 負の閾値）

位置: 価格が一時的に上がってきていること（Position > 0.6）

※「下降トレンド中なのに、価格は高値圏（60%以上）にある」＝絶好の戻り売りチャンスと判断。

4. トレードシナリオ（具体例）

どのようなタイミングで売買が行われるかの具体例です。

ケース1：上昇トレンドでの「押し目買い」成功例

環境:

過去100本の最高値: 150.00円 / 最安値: 149.00円 (値幅 1.00円)

トレンド傾き (Slope): 0.0005 (強い上昇トレンド判定)

現在:

価格: 149.30円

相対位置 (Position): 0.30 (30%の位置)

判定:

Slopeがプラス、かつPositionが0.4未満（安値圏）なので BUY エントリー。

意味: 「全体は上げ調子だが、一時的に下がってきたお買い得な瞬間」を捉えた形。

ケース2：下降トレンドでの「戻り売り」成功例

環境:

過去100本の最高値: 150.00円 / 最安値: 149.00円

トレンド傾き (Slope): -0.0008 (強い下降トレンド判定)

現在:

価格: 149.70円

相対位置 (Position): 0.70 (70%の位置)

判定:

Slopeがマイナス、かつPositionが0.6以上（高値圏）なので SELL エントリー。

意味: 「全体は下げ調子だが、一時的に反発して上がってきた瞬間」を狙い撃ちした形。

ケース3：エントリー見送り（リスクリワード不足）

状況: 条件は揃っているが、直近の壁（損切りライン）までの距離が遠すぎる場合。

計算:

期待できる利益 (Reward): 10pips

想定される損失 (Risk): 20pips

比率: 0.5 (1.0未満)

判定: NO_TRADE (見送り)。

意味: 「勝てそうだけど、負けた時のダメージの方が大きいからやめておく」というプロの判断。

5. 決済・リスク管理ルール (AIの「守り」)

エントリーと同時に、どこで逃げるか（SL）とどこで利益確定するか（TP）を算出します。固定pipsではなく、相場の状況に合わせて変化します。

損切りライン (Stop Loss)

買いの場合: 直近の最安値 - (ATR × 係数)

売りの場合: 直近の最高値 + (ATR × 係数)

意味: 「直近の壁を、相場のノイズ（ATR）分だけ明確に超えられたら、トレンド転換とみなして撤退する」というロジック。

利確ライン (Take Profit)

買いの場合: 直近の最高値 - (ATR × 係数)

売りの場合: 直近の最安値 + (ATR × 係数)

意味: 「直近の壁の手前で確実に利益を確保する」というロジック。

リスクリワード・フィルター (最後の砦)

計算されたSLとTPを見て、「リスク（損失額）」に対して「リワード（利益額）」が見合わない場合は、エントリーをキャンセルします。

条件: Reward ÷ Risk >= 1.0

この機能により、「勝率は高いけどコツコツドカンで負ける」エントリーを自動的に排除します。

6. 設定パラメータ (Parameters)

main_advanced.py 内で調整可能な数値です。

パラメータ名

デフォルト値

説明

HISTORY_SIZE

100

環境認識に使用する過去ローソク足の本数（推奨: 50〜200）

ATR_PERIOD

14

ボラティリティ計算期間（一般的）

Slope閾値

0.0001

これ以上の傾きでトレンド発生とみなす感度

Position閾値

0.4 / 0.6

押し目・戻り目の深さ判定（0.382 / 0.618 などフィボナッチ数値への変更も有効）

7. 目標金額別：推奨設定ガイド (Recommended Settings)

現在のAIロジック（線形回帰チャネル＋ATR）の特性を活かし、目標月収を達成するための最適な「通貨ペア」と「時間足」の組み合わせリストです。

Lv.1 【月5万】堅実にコツコツ狙う

「負けないこと」を最優先にする設定です。
AIが得意とする「きれいなトレンド」が出やすいメジャー通貨を選びます。

推奨通貨: USDJPY（ドル円） または EURUSD（ユーロドル）

時間足: H1（1時間足）

特徴:

世界で最も取引量が多く、突発的な乱高下（ノイズ）が少ない。

AIが描く「チャネルライン」通りに素直に動くことが多いため、勝率が安定しやすい。

ストレスが少なく、放置運用に最適。

Lv.2 【月5万〜20万】少しアグレッシブに攻める

「利益の爆発力」を取り入れる設定です。
値動き（ボラティリティ）が大きい通貨を使い、1回のトレンドで大きく稼ぎます。

推奨通貨: GBPJPY（ポンド円） または GBPUSD（ポンドドル）

時間足: H1（1時間足） または M30（30分足）

特徴:

通称「暴れ馬」。一度トレンドが出ると、ドル円の1.5倍〜2倍の値幅で動きます。

現在のAIロジック（順張り）と非常に相性が良く、トレンド発生時の爆益が期待できます。

ただし、損切り幅（ATR）も広くなるため、資金管理には注意が必要。

Lv.3 【月20万〜50万】プロ級のボラティリティで稼ぐ

「ゴールドの破壊力」を利用する設定です。
通常の通貨ペアでは届かない利益率を叩き出すための選択肢です。

推奨通貨: XAUUSD（ゴールド / 金）

時間足: H1（1時間足）

特徴:

ボラティリティの王様。1日で数ヶ月分の値動きをすることもあります。

今回実装した「ATRによる動的損切り」が最も輝く銘柄です（荒い動きに合わせて損切りラインを自動で広げてくれるため、振り落とされにくい）。

注意: ロット数は通貨ペアの半分以下（0.01〜0.05）から始めることを強く推奨。

Lv.4 【月50万以上】24時間365日フル稼働

「眠らない市場」で機会損失をゼロにする設定です。
為替市場が止まっている土日も利益を積み上げ、圧倒的な回転数で稼ぎます。

推奨通貨: BTCJPY（ビットコイン） または BTCUSD

時間足: M15（15分足） 〜 H1（1時間足）

特徴:

最大のメリット: 土日・祝日も稼働し続けること。

通常のFXが月20日稼働なのに対し、ビットコインは月30日稼働（1.5倍のチャンス）。

今回の「Robust Fix（強力補正版）」EAにより、ビットコイン特有のエラーも回避して発注可能。

トレンドが一度出ると長く続くため、AIが「Slope（傾き）」を検知しやすい。

8. 上級者向け：ロジックチューニング (Advanced Tuning)

main_advanced.py 内の計算式（ATR係数）を変更することで、銘柄の特性に合わせた最適化が可能です。

変更箇所

コードの125行目〜140行目付近（analyze_market_logic 関数内）。
sl = lowest_price - (atr * 0.5) の 0.5 の部分。

銘柄別推奨係数

目標Lv

推奨銘柄

推奨係数

理由

Lv.1~2

USDJPY / GBPJPY

0.5 (デフォルト)

為替は比較的動きが素直なので、狭めの設定で効率よく利益を確保します。

Lv.3

XAUUSD (ゴールド)

1.0 〜 1.5

ゴールドは「ヒゲ（一瞬の急変動）」が多いため、係数を広げて狩られないようにします。

Lv.4

BTCJPY (ビットコイン)

1.5 〜 2.0

ダマシが非常に多いため、かなり余裕を持たせた損切りラインを設定し、大きなトレンドだけを狙います。

9. 今後の拡張性

現在のロジックは「テクニカル分析」の王道ですが、Pythonサーバー構成のため以下のような拡張が容易です。

ファンダメンタルズ分析: ニュースAPIを組み込み、「重要指標発表前はSlope閾値を厳しくする」などの制御。

機械学習(ML)の実装: 「Slope」や「ATR」などの数値を入力データとし、未来の価格変動を予測するAIモデルへの置き換え。

10. 運用手順と注意点（Operation Rule）

本システムはサーバー側で学習データを保持するため、以下の手順を遵守してください。

正しい起動手順

Pythonサーバーを起動する。
コマンドプロンプト（黒い画面）で以下のコマンドを実行します。

python main_advanced.py


※ Uvicorn running on http://0.0.0.0:8000 と表示されれば起動成功です。

MT5で運用したい「時間足」を選択する（例：H1チャートを開く）。

その後に、EAをチャートにドラッグ＆ドロップする。

これにより、選択した時間足の過去データが正しくサーバーに同期されます。

時間足を変更したい場合

途中で時間足を変更（例：H1 → M15）する場合は、以下のリセット作業が必須です。
そのまま切り替えると、サーバー内で異なる時間足のデータが混ざり、誤動作の原因になります。

Pythonサーバーを停止する（Ctrl + C）。

Pythonサーバーを再起動する（再度 python main_advanced.py を実行）。

MT5で新しい時間足を選択し、EAを再度入れ直す（または再読み込みする）。

11. 異常検知の目安（Troubleshooting）

システムが正常に動いているか、止まっているかを判断する時間的な目安です。

ケースA：起動直後（セットアップ時）

正常: EAをチャートに入れた直後（10秒以内）に、MT5エキスパートタブに History Sync Success、Pythonログに Loaded History... が表示される。

異常: 30秒経っても何も表示されない、または Connection Error が出る。

原因: サーバー未起動、URL設定ミス（/signalの有無など）、DLL許可設定漏れ。

ケースB：稼働中（待機時）

正常: 選択した時間足の「ローソク足が確定したタイミング（00秒）」で通信が発生する。

例: 1時間足なら、10:00, 11:00, 12:00... の直後にログが流れる。

異常: 足が確定してから 2分以上 経過しても、Python側の黒い画面に新しいログ（Env: Range=...）が出ない。

原因: MT5がフリーズしている、PCのスリープ、自動売買ボタンがOFFになった。

ケースC：例外（動かなくて良い時）

土日・祝日（市場クローズ中）: チャート自体が動かないため、EAも沈黙します（正常）。

確認方法: 仮想通貨（BTCUSDなど）のチャートで動くか試す。

以上