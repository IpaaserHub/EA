# AI EA サーバーテストルールブック
> 最終更新: 2026-01-04

## 概要

AI決済判断機能のバックテストを実行するための標準ルールを定義します。

---

## テスト実行方法

### 1. サーバー起動確認
```bash
# ポート8000が使用中か確認
netstat -ano | findstr :8000

# サーバー起動
python main_genai_custom.py
```

### 2. バックテスト実行
```bash
python test_backtest.py
```

---

## デフォルトテスト設定

### 投資想定
| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| 初期資金 | 1,000,000円 | 想定投資額 |
| ロットサイズ | 0.01 lot | 取引単位 |
| 1日トレード数 | 5回 | 収益予測の基準 |

### テスト規模
| 項目 | デフォルト値 |
|------|-------------|
| テスト件数 | 100件/ペア |
| 通貨ペア | BTCJPY, USDJPY, XAUUSD |
| 並行実行 | Yes |
| 価格バー数 | 100本 |

### SL/TP設定（損小利大原則）
| 項目 | 設定 | 理由 |
|------|------|------|
| SL距離 | 10-30 tick | 狭く設定し損失を限定 |
| TP距離 | 50-120 tick | 広く設定し利益を伸ばす |

---

## 通貨ペア設定

| ペア | 基準価格 | Tick | 平均勝ち | 平均負け |
|------|---------|------|----------|----------|
| BTCJPY | 14,000,000 | 5000 | +3,000円 | -2,000円 |
| USDJPY | 157.50 | 0.05 | +2,000円 | -1,500円 |
| XAUUSD | 2,650.00 | 1.0 | +2,500円 | -1,800円 |

---

## 出力項目

### 前提条件（必須）
テスト結果を出す際は、必ず以下の前提条件を先に表示すること：
- 日時
- サーバーURL
- アカウントID
- 通貨ペア
- テスト件数
- 投資想定（初期資金、ロット、1日トレード数）

### ペア別結果（必須）
各通貨ペアごとに以下を表示：
- 入金想定額
- AI正解率
- AI判断分布（HOLD/CLOSE）
- 期待値分布（HOLD/CLOSE/EITHER）
- エラー種別（FalseClose, FalseHold）
- 勝率（W/L）
- 平均勝ち/負け
- Profit Factor
- 総損益

### 総合結果（必須）
- 入金想定額
- 総テスト数
- 総AI正解率
- AI出力比率
- 総エラー数
- 勝率
- 平均勝ち/負け
- Profit Factor
- 総損益
- 日次予測損益
- 月次予測損益
- 月次ROI

### 改善案（自動出力）
テスト結果に基づき、以下の分析が自動出力される：

1. **FalseClose分析** - 早期利確の原因特定
   - 利益ポジションの早期決済パターン
   - トレンド順方向ポジションの決済傾向

2. **FalseHold分析** - 損切り遅延の原因特定
   - 損失ポジションの保持パターン
   - トレンド逆方向ポジションの保持傾向

3. **ペア別問題特定** - PF < 1.0のペアを特定
   - シンボル固有の改善提案

4. **優先アクション** - 最も重要な改善項目を提示

---

## 判断基準（期待値の決定ロジック）

```python
# トレンドとポジションの整合性
trend_aligned = (trend == "up" and position == "BUY") or
                (trend == "down" and position == "SELL")

# 判断ロジック
if trend_against and profit < 0:
    return "CLOSE"  # 逆方向+損失 = 損切り
elif trend_aligned and small_profit:
    return "HOLD"   # 順方向+小利益 = 伸ばす
elif large_profit:
    return "EITHER" if trend_aligned else "CLOSE"
elif large_loss:
    return "CLOSE"
elif trend == "range":
    return "EITHER"
else:
    return "HOLD" if trend_aligned and profit > 0 else "CLOSE"
```

---

## 成功基準

| 指標 | 最低基準 | 目標値 |
|------|---------|--------|
| AI正解率 | 80% | 90%+ |
| Profit Factor | 1.0 | 1.5+ |
| 月次ROI | 0% | +5%+ |
| FalseClose率 | <15% | <5% |
| FalseHold率 | <10% | <3% |

---

## トラブルシューティング

### サーバーに接続できない
```bash
# ポート確認
netstat -ano | findstr :8000

# 古いプロセスを終了
taskkill /PID <PID> /F
```

### License Invalid エラー
- `ALLOWED_ACCOUNTS`にアカウントIDが含まれているか確認
- `test_backtest.py`の`ACCOUNT_ID`が正しいか確認

### DataInsufficient エラー
- 価格履歴が20本未満の場合に発生
- `/history`エンドポイントで事前に価格データを送信

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-04 | 初版作成 |
| 2026-01-04 | 損小利大原則のSL/TP設定追加 |
| 2026-01-04 | ペア別P/L統計を出力に追加 |
| 2026-01-04 | 改善案の自動出力機能追加 |
| 2026-01-04 | テスト閾値を相対値に修正 |
