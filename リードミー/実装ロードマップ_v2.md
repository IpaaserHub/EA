# AI EA 実装ロードマップ v2.0
> 最終更新: 2026-01-04

## 現在のバージョン: v6.4.0

---

## 重大な考え方

### FXで勝敗を分ける5つの要素

| # | 要素 | 重要度 | 備考 |
|---|------|--------|------|
| 1 | **エントリー精度** | ★★★ | 勝率55-60%で十分。完璧を求めすぎない |
| 2 | **決済タイミング** | ★★★★★ | **最重要**。利益を伸ばし、損切りは即座に |
| 3 | **リスク管理** | ★★★★ | 1トレード資金の2%以内 |
| 4 | **市場選択** | ★★★ | トレンド相場(30%)で勝ち、レンジ(70%)を避ける |
| 5 | **心理排除** | ★★★ | EA化で解決済み |

### 生成AIを使うべき場面 vs 使うべきでない場面

**AIが得意なこと:**
- 複数要因の総合判断（チャート + ニュース + 指標）
- パターン認識（ダブルトップ、ヘッドアンドショルダー等）
- 自然言語の解釈（ニュースセンチメント）
- 文脈を踏まえた推論

**AIを使うべきでないこと:**
- 単純な閾値判定 → ルールベースで十分
- 統計計算（勝率、平均P/L）→ コードで計算
- 少数サンプルからの予測 → 統計的に無意味

### 機能提案時のチェックリスト

新機能を検討する際、以下を確認すること：

1. **AIの強みを活かせるか？**
   - 推論、文脈理解、パターン認識が必要か？
   - YES → AI向き / NO → ルールベースで実装

2. **ルールベースで十分では？**
   - 固定の計算式や閾値で実現可能か？
   - YES → コードで実装 / NO → AI検討

3. **実際の効果はあるか？**
   - 理論的に正しそう ≠ 実際に効果がある
   - 「簡単だから」で実装しない

### AI EA開発の実装原則

#### 1. コストとレイテンシーを意識する
```
AI呼び出し1回 = 約0.5〜2円 + 0.5〜2秒の遅延
```
- 高頻度呼び出し → コスト増 + 遅延で機会損失
- エントリー判断時のみAI使用（毎Tickでは呼ばない）

#### 2. フォールバック設計を必ず用意する
```
AI障害時に何もできない = 危険
```
- AI応答失敗 → ルールベースのデフォルト値を使用
- 現状: `fallback_sl`, `fallback_tp` で対応済み

#### 3. AIの一貫性問題を理解する
```
同じプロンプト → 毎回違う回答の可能性
```
- `temperature=0.3` で安定性を確保（現状実装済み）
- 重要判断は `temperature=0` を検討

#### 4. シンプルさの価値を忘れない
```
複雑なシステム = デバッグ困難 + 障害点増加
シンプルな戦略で勝てないなら、複雑にしても勝てない
```
- 機能追加前に「本当に必要か？」を問う
- 既存機能で代替できないか検討

---

### 失敗例: 直近履歴のAI連携

**やったこと:** 直近10件のトレード履歴をAIプロンプトに追加

**問題点:**
- 10件は統計的に無意味（最低100件必要）
- AIの得意分野（推論・パターン認識）と無関係
- クールダウン機能で既に対応済みの内容

**教訓:**
- 「工数が低い」と「効果がある」は別
- 表面的に理屈が通っても、本質を見極める

---

### 実装済み機能 (Phase 1 完了)
- [x] 基本通信・取引機能
- [x] 線形回帰チャネル + ATR によるエントリー判断
- [x] 銘柄別設定（SYMBOL_CONFIG）
- [x] クールダウン機能（3連敗で一定時間休止）
- [x] ポジション数制限（銘柄別）
- [x] RSIフィルター追加
- [x] 時間帯フィルター（東京/ロンドン/NY）
- [x] 決済結果のサーバー報告（OnTradeTransaction）
- [x] CSV出力機能

---

## Phase 2: AI活用の本格化 (次の優先事項)

### 2.1 AIによるSL/TP決定 ⭐最優先
**現状**: AIは「GO/STOP」の承認役のみ
**目標**: AIがSL/TP価格を直接提案

```
現在のフロー:
ロジック判断 → AI「GO?」→ 固定計算SL/TP

改善後:
ロジック判断 → AI「SL=○○、TP=○○を提案」→ 採用
```

**実装内容**:
1. プロンプト改善: より多くの指標をAIに渡す
   - 現在: slope, atr, position
   - 追加: RSI, 高値/安値, 現在価格, 直近勝敗
2. AI応答のJSON化: `{"action": "BUY", "sl": 14500.0, "tp": 15200.0, "reason": "..."}`
3. パース処理の実装

**工数**: 中（1-2日）

---

### 2.2 直近トレード履歴のAI連携
**目的**: AIに過去の文脈を与えて判断精度向上

```python
# プロンプトに追加
「直近10トレード: 勝6/負4、BTCJPYは3連敗中」
```

**実装内容**:
1. DBから直近トレード結果を取得
2. プロンプトに履歴サマリーを含める

**工数**: 低（数時間）

---

### 2.3 決済判断のAI化
**現状**: 固定SL/TPで決済
**目標**: ポジション保有中もAIが「今決済すべきか」を判断

**実装内容**:
1. 保有ポジションの含み損益をAIに送信
2. AIが「HOLD/CLOSE」を判断
3. CLOSEの場合、EAが決済実行

**工数**: 高（2-3日）

---

## Phase 2.5: ユーザビリティ向上

### 2.5.1 Discord/LINE通知
```
🚀 [BUY] USDJPY @ 157.50
AI判断: 上昇トレンド継続、RSI=35で押し目
SL: 157.20 / TP: 158.00
```

**工数**: 中（1日）

### 2.5.2 ダッシュボード強化
- 現在のAI判断コメント表示
- 銘柄別勝率グラフ
- クールダウン状態表示

**工数**: 中（1日）

---

## Phase 3: 高度な分析

### 3.1 マルチタイムフレーム (MTF)
**目的**: 長期足でトレンド確認、短期足でエントリー

**実装内容**:
1. EAから複数時間足データを送信（M1 + H1）
2. サーバーで長期トレンドを判定
3. 長期トレンドに逆らうエントリーを回避

**工数**: 高（2-3日）

---

### 3.2 ファンダメンタルズ統合
**目的**: 経済指標発表前後を回避

**実装内容**:
1. 経済指標カレンダーAPI連携
2. 重要指標前後30分はNO_TRADE

**工数**: 中（1日）

---

### 3.3 ニュースセンチメント分析
**目的**: ニュースの感情分析でフィルター

**実装内容**:
1. ニュースAPI連携
2. AIでセンチメントスコア算出（-10〜+10）
3. スコアが低い時はエントリー回避

**工数**: 高（2-3日）

---

## Phase 4: 機械学習への進化 (将来)

### 4.1 予測モデル構築
- LightGBM / XGBoost による価格予測
- 特徴量: 過去価格、インジケーター、時間帯、曜日等

### 4.2 強化学習エージェント
- 報酬: 利益最大化
- 行動: BUY/SELL/HOLD

---

## 優先順位サマリー

| 順位 | 項目 | 効果 | 工数 | 状態 |
|------|------|------|------|------|
| - | RSI + 時間帯フィルター | ★★★ | 低 | ✅完了 |
| - | クールダウン + ポジション制限 | ★★★ | 低 | ✅完了 |
| - | **AIによるSL/TP決定** | ★★★★ | 中 | ✅完了 |
| - | ~~直近履歴のAI連携~~ | - | - | ❌削除（効果なし） |
| - | **決済判断のAI化** | ★★★★ | 高 | ✅完了 |
| 1 | Discord/LINE通知 | ★★ | 中 | 🔜次 |
| 2 | MTF分析 | ★★★ | 高 | 未着手 |
| 3 | ファンダメンタルズ | ★★ | 中 | 未着手 |
| 4 | ニュースセンチメント | ★★ | 高 | 未着手 |
| 5 | ML予測モデル | ★★★★ | 非常に高 | 将来 |

---

## 次のアクション

**Phase 2.5.1「Discord/LINE通知」の実装**

1. Webhook URL設定の追加
2. エントリー時の通知送信関数作成
3. 決済時の通知送信関数作成
4. AI判断理由の通知への組み込み

---

## 実装完了: Phase 2.3「決済判断のAI化」

**v6.4.0で実装完了**

サーバー側:
- `/check_exit` エンドポイント追加
- `ask_genai_exit_decision()` 関数追加
- 保有時間、含み損益、RSI、トレンドを考慮したAI判断

EA側:
- `CheckAIExitSignals()` 関数追加（60秒間隔で呼び出し）
- `ClosePositionByTicket()` 関数追加
- OnTickに定期チェック統合
- `UseAIExitCheck` / `ExitCheckInterval` パラメータ追加
